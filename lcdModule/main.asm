;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Thu Oct 27 2016
; Processor: PIC16F688
; Compiler:  MPASM (Proteus)
;====================================================================

;====================================================================
; DEFINITIONS
;====================================================================

#include p16f688.inc                ; Include register definition file
; CONFIG
; __config 0xFFD4
 __CONFIG _FOSC_INTOSCIO & _WDTE_OFF & _PWRTE_OFF & _MCLRE_OFF & _CP_OFF & _CPD_OFF & _BOREN_ON & _IESO_ON & _FCMEN_ON

;====================================================================
; VARIABLES
;====================================================================
   x	EQU	0x21
   y	EQU	0x22
   hi	EQU	0x23
   lo	EQU	0x24
   
   #define	lcdPort	PORTC
   #define	rs	PORTA, 0
   #define	en	PORTA, 1
   ; RW is grounded
   ; D4 ----> RC0
   ; D5 ----> RC1
   ; D6 ----> RC2
   ; D7 ----> RC3


   
;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================     
      ; Reset Vector
      ORG	0x0000
      GOTO	setup
      
      ORG	0x0004
      RETFIE

;====================================================================
; CODE SEGMENT
;====================================================================
setup:
      ; PIC pre configurations
      BANKSEL	CMCON0
      MOVLW	0x07
      MOVWF	CMCON0
      BANKSEL	ANSEL
      CLRF	ANSEL
      CLRF	TRISC
      CLRF	TRISA
      
      BANKSEL	PORTC
      CLRF	PORTC	; Data purposes
      CLRF	PORTA	; Control purposes
      CALL	lcdInit
      
;====================================================================
; MAIN LOOP
;====================================================================
loop:
      CALL	message
      GOTO	loop

;====================================================================
; CONTROL AND DATA FUNCTIONS
;====================================================================      
; Init sequence must be:
; RC0 1 2 3 - Registers from PORTC
;  D4 5 6 7 - Pins from LM016L
;   0 0 1 1
;   0 0 1 1
;   0 0 1 1
;   0 0 1 0 ; End of init sequence
;   0 0 1 0
;   1 0 0 0 ; End of 4 bit sequence
;   0 0 0 0
;   1 1 1 1 ; End of blinking cursor sequence
lcdInit:
      BANKSEL	PORTA
      ;Control bits already cleared at setup
      ;BCF	rs	; ControlMode=0, DataMode=1
      ;BCF	en	; Wait config=0, SendConfig=1
      MOVLW	H'33'	; Init command
      MOVWF	PORTC
      CALL	writeCmd
      MOVLW	H'32'	; Init command
      MOVWF	PORTC
      CALL	writeCmd
      MOVLW	H'28'	; 4 bit mode
      MOVWF	PORTC
      CALL	writeCmd
      MOVLW	H'0F'	; Display blinking on cursor
      MOVWF	PORTC
      CALL	writeCmd
      RETURN

message:
      MOVLW	H'01'		; Clear screen
      CALL	writeCmd
      MOVLW	H'80'		; First line command
      CALL	writeCmd
      MOVLW	'A'
      CALL	writeData
      MOVLW	't'
      CALL	writeData
      MOVLW	't'
      CALL	writeData
      MOVLW	'e'
      CALL	writeData
      MOVLW	'n'
      CALL	writeData
      MOVLW	'd'
      CALL	writeData
      MOVLW	'a'
      CALL	writeData
      MOVLW	'n'
      CALL	writeData
      MOVLW	't'
      CALL	writeData
      MOVLW	' '
      CALL	writeData
      MOVLW	'M'
      CALL	writeData
      MOVLW	'o'
      CALL	writeData
      MOVLW	'd'
      CALL	writeData
      MOVLW	'u'
      CALL	writeData
      MOVLW	'l'
      CALL	writeData
      MOVLW	'e'
      CALL	writeData
      MOVLW	H'C0'		; Second line command
      CALL	writeCmd	
      CALL	lDelay		; Wait a little
      MOVLW	'M'
      CALL	writeData
      MOVLW	'i'
      CALL	writeData
      MOVLW	'c'
      CALL	writeData
      MOVLW	'r'
      CALL	writeData
      MOVLW	'o'
      CALL	writeData
      MOVLW	'c'
      CALL	writeData
      MOVLW	'o'
      CALL	writeData
      MOVLW	'n'
      CALL	writeData
      MOVLW	't'
      CALL	writeData  
      MOVLW	'r'
      CALL	writeData  
      MOVLW	'o'
      CALL	writeData
      MOVLW	'l'
      CALL	writeData
      MOVLW	'l'
      CALL	writeData
      MOVLW	'e'
      CALL	writeData  
      MOVLW	'r'
      CALL	writeData  
      MOVLW	's'
      CALL	writeData
      MOVLW	'!'
      CALL	writeData  
      CALL	lDelay
      RETURN
      

runCmd:
      BSF	en	; E=1 (Connect to module), E=0(Disconnect)	
      CALL	delay
      BCF	en	; E=0
      CALL	delay
      CALL	delay
      RETURN
      
writeData:
      CALL	getNibble
      MOVF	lo, W
      MOVWF	PORTC
      BSF	rs
      CALL	runCmd
      
      MOVF	hi, W
      MOVWF	PORTC      
      CALL	runCmd
      RETURN
      
writeCmd:
      CALL	getNibble
      MOVF	lo, W
      MOVWF	PORTC
      BCF	rs
      CALL	runCmd
      
      MOVF	hi, W
      MOVWF	PORTC      
      CALL	runCmd
      RETURN
      
getNibble:
      MOVWF	lo
      MOVWF	hi
      SWAPF	lo, 1
      RETURN
      
delay:
      MOVLW	D'1'
      MOVWF	x
counterTwo:
      MOVLW	D'31'
      MOVWF	y
counterOne:
      DECFSZ	y, 1
      GOTO	counterOne
      DECFSZ	x, 1
      GOTO	counterTwo 
      RETURN

lDelay:
      MOVLW	D'16'
      MOVWF	x
lCounterTwo:
      MOVLW	D'128'
      MOVWF	y
lCounterOne:
      DECFSZ	y, 1
      GOTO	lCounterOne
      DECFSZ	x, 1
      GOTO	lCounterTwo 
      RETURN

;====================================================================
   END
